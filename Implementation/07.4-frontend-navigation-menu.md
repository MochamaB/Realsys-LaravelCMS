# Frontend - Navigation Menu

This document outlines the navigation menu system for the CMS, explaining how menus are generated and rendered on the frontend.

## Menu System Overview

The menu system consists of several components:

1. **Menu Model**: Represents a menu location (e.g., main, footer)
2. **MenuItem Model**: Represents items within a menu
3. **Menu Rendering**: Renders menus in the frontend templates
4. **Active Item Detection**: Highlights the current page in the menu

## Menu and MenuItem Models

The `Menu` and `MenuItem` models handle the storage and retrieval of menu data:

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Menu extends Model
{
    protected $fillable = [
        'name',
        'location',
        'description',
        'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean'
    ];

    // Relationships
    public function items()
    {
        return $this->hasMany(MenuItem::class);
    }

    // Get top-level menu items
    public function topLevelItems()
    {
        return $this->items()->whereNull('parent_id')->orderBy('order_index');
    }

    /**
     * Get a menu by its location
     *
     * @param string $location
     * @return Menu|null
     */
    public static function getByLocation(string $location)
    {
        return self::where('location', $location)
                   ->where('is_active', true)
                   ->with(['items' => function($query) {
                       $query->where('is_active', true)
                             ->orderBy('order_index')
                             ->with(['children' => function($q) {
                                 $q->where('is_active', true)
                                   ->orderBy('order_index');
                             }]);
                   }])
                   ->first();
    }
}
```

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class MenuItem extends Model
{
    protected $fillable = [
        'menu_id',
        'parent_id',
        'title',
        'link_type',
        'page_id',
        'custom_url',
        'target',
        'css_class',
        'order_index',
        'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean'
    ];

    // Relationships
    public function menu()
    {
        return $this->belongsTo(Menu::class);
    }

    public function parent()
    {
        return $this->belongsTo(MenuItem::class, 'parent_id');
    }

    public function children()
    {
        return $this->hasMany(MenuItem::class, 'parent_id')->orderBy('order_index');
    }

    public function page()
    {
        return $this->belongsTo(Page::class);
    }

    /**
     * Get the URL for this menu item
     * 
     * @return string
     */
    public function getUrl()
    {
        if ($this->link_type === 'custom' && $this->custom_url) {
            return $this->custom_url;
        }

        if ($this->link_type === 'page' && $this->page) {
            return route('page.show', $this->page->slug);
        }

        return '#';
    }

    /**
     * Check if this menu item is active based on the current URL
     * 
     * @return boolean
     */
    public function isActive()
    {
        $currentUrl = url()->current();
        $itemUrl = $this->getUrl();
        
        // If this is an exact match
        if ($currentUrl === $itemUrl) {
            return true;
        }
        
        // If this is a parent item and we're on a child page
        if ($this->children->count() > 0) {
            foreach ($this->children as $child) {
                if ($child->isActive()) {
                    return true;
                }
            }
        }
        
        // Check if this is a page and we're on that page
        if ($this->link_type === 'page' && $this->page) {
            $pageUrl = route('page.show', $this->page->slug);
            return $currentUrl === $pageUrl;
        }
        
        return false;
    }
}
```

## Menu Rendering

Menus are rendered in the frontend templates using Blade components:

```php
<!-- resources/themes/miata/partials/navigation.blade.php -->
<nav class="navbar navbar-expand-lg">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"><i class="fas fa-bars"></i></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            @if($mainMenu)
                @foreach($mainMenu->topLevelItems()->get() as $item)
                    @if($item->children->count() > 0)
                        <li class="nav-item dropdown {{ $item->isActive() ? 'active' : '' }}">
                            <a class="nav-link dropdown-toggle" href="{{ $item->getUrl() }}" role="button" data-bs-toggle="dropdown">
                                {{ $item->title }}
                            </a>
                            <ul class="dropdown-menu">
                                @foreach($item->children as $child)
                                    <li><a class="dropdown-item {{ $child->isActive() ? 'active' : '' }}" href="{{ $child->getUrl() }}">{{ $child->title }}</a></li>
                                @endforeach
                            </ul>
                        </li>
                    @else
                        <li class="nav-item {{ $item->isActive() ? 'active' : '' }}">
                            <a class="nav-link" href="{{ $item->getUrl() }}">{{ $item->title }}</a>
                        </li>
                    @endif
                @endforeach
            @endif
        </ul>
    </div>
</nav>
```

## Menu Component

For more complex menu rendering, a dedicated Blade component can be created:

```php
namespace App\View\Components;

use App\Models\Menu;
use Illuminate\View\Component;

class NavigationMenu extends Component
{
    public $menu;
    public $location;
    public $cssClass;
    
    /**
     * Create a new component instance.
     *
     * @param string $location
     * @param string $cssClass
     * @return void
     */
    public function __construct($location = 'main', $cssClass = '')
    {
        $this->location = $location;
        $this->cssClass = $cssClass;
        $this->menu = Menu::getByLocation($location);
    }
    
    /**
     * Get the view / contents that represent the component.
     *
     * @return \Illuminate\View\View
     */
    public function render()
    {
        return view('theme::components.navigation-menu');
    }
}
```

```php
<!-- resources/themes/miata/components/navigation-menu.blade.php -->
@if($menu)
    <nav class="navigation-menu {{ $cssClass }}">
        <ul class="menu-items">
            @foreach($menu->topLevelItems()->get() as $item)
                @if($item->children->count() > 0)
                    <li class="menu-item has-dropdown {{ $item->isActive() ? 'active' : '' }}">
                        <a href="{{ $item->getUrl() }}" class="{{ $item->css_class }}" target="{{ $item->target }}">
                            {{ $item->title }}
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <ul class="dropdown-menu">
                            @foreach($item->children as $child)
                                <li class="menu-item {{ $child->isActive() ? 'active' : '' }}">
                                    <a href="{{ $child->getUrl() }}" class="{{ $child->css_class }}" target="{{ $child->target }}">
                                        {{ $child->title }}
                                    </a>
                                </li>
                            @endforeach
                        </ul>
                    </li>
                @else
                    <li class="menu-item {{ $item->isActive() ? 'active' : '' }}">
                        <a href="{{ $item->getUrl() }}" class="{{ $item->css_class }}" target="{{ $item->target }}">
                            {{ $item->title }}
                        </a>
                    </li>
                @endif
            @endforeach
        </ul>
    </nav>
@endif
```

## Mobile Menu

The mobile menu requires special handling to ensure proper display on small screens:

```php
<!-- resources/themes/miata/partials/mobile-menu.blade.php -->
<div class="mobile-menu">
    <div class="menu-backdrop"></div>
    <div class="close-btn"><i class="fas fa-times"></i></div>
    
    <nav class="menu-box">
        <div class="nav-logo">
            <a href="{{ route('home') }}">
                <img src="{{ settings('site_logo') ? asset('storage/' . settings('site_logo')) : theme_asset('images/logo.png') }}" alt="{{ config('app.name') }}">
            </a>
        </div>
        
        <div class="menu-outer">
            <ul class="navigation">
                @if($mainMenu)
                    @foreach($mainMenu->topLevelItems()->get() as $item)
                        @if($item->children->count() > 0)
                            <li class="dropdown {{ $item->isActive() ? 'current' : '' }}">
                                <a href="{{ $item->getUrl() }}">{{ $item->title }}</a>
                                <ul>
                                    @foreach($item->children as $child)
                                        <li class="{{ $child->isActive() ? 'current' : '' }}">
                                            <a href="{{ $child->getUrl() }}">{{ $child->title }}</a>
                                        </li>
                                    @endforeach
                                </ul>
                                <div class="dropdown-btn"><span class="fas fa-angle-down"></span></div>
                            </li>
                        @else
                            <li class="{{ $item->isActive() ? 'current' : '' }}">
                                <a href="{{ $item->getUrl() }}">{{ $item->title }}</a>
                            </li>
                        @endif
                    @endforeach
                @endif
            </ul>
        </div>
        
        <div class="contact-info">
            <h4>Contact Info</h4>
            <ul>
                <li>{{ settings('contact_address') }}</li>
                <li><a href="tel:{{ settings('contact_phone') }}">{{ settings('contact_phone') }}</a></li>
                <li><a href="mailto:{{ settings('contact_email') }}">{{ settings('contact_email') }}</a></li>
            </ul>
        </div>
        
        <div class="social-links">
            @foreach(settings('social_media', []) as $platform => $url)
                <a href="{{ $url }}"><i class="fab fa-{{ $platform }}"></i></a>
            @endforeach
        </div>
    </nav>
</div>
```

## Menu Service

A dedicated service class can handle more complex menu operations:

```php
namespace App\Services;

use App\Models\Menu;
use App\Models\MenuItem;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Cache;

class MenuService
{
    /**
     * Get a menu by its location with caching
     *
     * @param string $location
     * @param int $cacheDuration Minutes to cache the menu
     * @return Menu|null
     */
    public function getMenuByLocation($location, $cacheDuration = 60)
    {
        $cacheKey = "menu_{$location}_" . app()->getLocale();
        
        return Cache::remember($cacheKey, $cacheDuration * 60, function () use ($location) {
            return Menu::getByLocation($location);
        });
    }
    
    /**
     * Generate a breadcrumb menu for a page
     *
     * @param \App\Models\Page $page
     * @return Collection
     */
    public function generateBreadcrumbs($page)
    {
        $breadcrumbs = collect();
        
        // Add home page
        $breadcrumbs->push([
            'title' => 'Home',
            'url' => route('home')
        ]);
        
        // If page has parent, add parent pages
        if ($page->parent_id) {
            $this->addParentBreadcrumbs($breadcrumbs, $page->parent);
        }
        
        // Add current page
        $breadcrumbs->push([
            'title' => $page->title,
            'url' => route('page.show', $page->slug),
            'active' => true
        ]);
        
        return $breadcrumbs;
    }
    
    /**
     * Add parent pages to breadcrumbs
     *
     * @param Collection $breadcrumbs
     * @param \App\Models\Page $parent
     * @return void
     */
    protected function addParentBreadcrumbs($breadcrumbs, $parent)
    {
        if ($parent->parent_id) {
            $this->addParentBreadcrumbs($breadcrumbs, $parent->parent);
        }
        
        $breadcrumbs->push([
            'title' => $parent->title,
            'url' => route('page.show', $parent->slug)
        ]);
    }
    
    /**
     * Find the active menu item for a page
     *
     * @param Menu $menu
     * @param \App\Models\Page $page
     * @return MenuItem|null
     */
    public function findActiveMenuItem($menu, $page)
    {
        // First, try to find a menu item that links directly to this page
        $menuItem = $menu->items()
            ->where('link_type', 'page')
            ->where('page_id', $page->id)
            ->first();
            
        if ($menuItem) {
            return $menuItem;
        }
        
        // If not found and page has a parent, try to find a menu item for the parent
        if ($page->parent_id) {
            return $this->findActiveMenuItem($menu, $page->parent);
        }
        
        return null;
    }
}
```

## Mega Menu

For more complex navigation structures, a mega menu can be implemented:

```php
<!-- resources/themes/miata/components/mega-menu.blade.php -->
@props(['menu'])

@if($menu)
    <div class="mega-menu">
        <div class="container">
            <div class="row">
                @foreach($menu->topLevelItems()->get() as $item)
                    <div class="col-lg-3">
                        <div class="mega-menu-column">
                            <h4>{{ $item->title }}</h4>
                            @if($item->children->count() > 0)
                                <ul>
                                    @foreach($item->children as $child)
                                        <li class="{{ $child->isActive() ? 'active' : '' }}">
                                            <a href="{{ $child->getUrl() }}">{{ $child->title }}</a>
                                        </li>
                                    @endforeach
                                </ul>
                            @endif
                        </div>
                    </div>
                @endforeach
            </div>
        </div>
    </div>
@endif
```

## JavaScript for Mobile Menu

The mobile menu requires JavaScript for proper functionality:

```javascript
// resources/themes/miata/assets/js/main.js

// Mobile Menu
function mobileMenu() {
    $('.mobile-menu-btn').on('click', function() {
        $('.mobile-menu').addClass('mobile-menu-visible');
    });

    $('.close-btn, .menu-backdrop').on('click', function() {
        $('.mobile-menu').removeClass('mobile-menu-visible');
    });

    $('.dropdown-btn').on('click', function() {
        $(this).prev('ul').slideToggle(500);
        $(this).toggleClass('active');
    });
}

// Initialize when document is ready
$(document).ready(function() {
    mobileMenu();
});
```

## Conclusion

The navigation menu system provides a flexible way to create and manage menus for the CMS. By using the `Menu` and `MenuItem` models, menus can be created for different locations on the site, such as the main navigation, footer, and sidebar. The system supports hierarchical menus with dropdown functionality and active item detection. The implementation is designed to work seamlessly with the Miata template while providing a robust backend architecture for menu management.

# Frontend - Form Handling

This document outlines the form handling system for the CMS, explaining how forms are created, validated, and processed on the frontend.

## Form System Overview

The form handling system consists of several components:

1. **Form Model**: Represents form definitions stored in the system
2. **Form Rendering**: Renders forms in the frontend templates
3. **Form Validation**: Validates form submissions
4. **Form Processing**: Processes form submissions
5. **Form Notifications**: Sends notifications for form submissions

## Form Model

The `Form` model handles the storage and retrieval of form data:

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Form extends Model
{
    protected $fillable = [
        'name',
        'title',
        'description',
        'success_message',
        'email_recipients',
        'store_submissions',
        'captcha_enabled',
        'is_active'
    ];

    protected $casts = [
        'email_recipients' => 'array',
        'store_submissions' => 'boolean',
        'captcha_enabled' => 'boolean',
        'is_active' => 'boolean'
    ];

    // Relationships
    public function fields()
    {
        return $this->hasMany(FormField::class)->orderBy('order_index');
    }

    public function submissions()
    {
        return $this->hasMany(FormSubmission::class);
    }

    /**
     * Get a form by its name
     *
     * @param string $name
     * @return Form|null
     */
    public static function getByName(string $name)
    {
        return self::where('name', $name)
                   ->where('is_active', true)
                   ->with(['fields' => function($query) {
                       $query->where('is_active', true)
                             ->orderBy('order_index');
                   }])
                   ->first();
    }
}
```

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class FormField extends Model
{
    protected $fillable = [
        'form_id',
        'name',
        'label',
        'type',
        'placeholder',
        'help_text',
        'default_value',
        'options',
        'validation_rules',
        'order_index',
        'is_required',
        'is_active'
    ];

    protected $casts = [
        'options' => 'array',
        'is_required' => 'boolean',
        'is_active' => 'boolean'
    ];

    // Relationships
    public function form()
    {
        return $this->belongsTo(Form::class);
    }

    /**
     * Get validation rules for this field
     *
     * @return string
     */
    public function getValidationRules()
    {
        $rules = [];
        
        if ($this->is_required) {
            $rules[] = 'required';
        } else {
            $rules[] = 'nullable';
        }
        
        // Add type-specific rules
        switch ($this->type) {
            case 'email':
                $rules[] = 'email';
                break;
                
            case 'number':
                $rules[] = 'numeric';
                break;
                
            case 'url':
                $rules[] = 'url';
                break;
                
            case 'date':
                $rules[] = 'date';
                break;
                
            case 'file':
                $rules[] = 'file';
                $rules[] = 'max:10240'; // 10MB
                break;
        }
        
        // Add custom validation rules
        if ($this->validation_rules) {
            $rules = array_merge($rules, explode('|', $this->validation_rules));
        }
        
        return implode('|', $rules);
    }
}
```

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class FormSubmission extends Model
{
    protected $fillable = [
        'form_id',
        'data',
        'ip_address',
        'user_agent',
        'is_read'
    ];

    protected $casts = [
        'data' => 'array',
        'is_read' => 'boolean'
    ];

    // Relationships
    public function form()
    {
        return $this->belongsTo(Form::class);
    }
}
```

## Form Service

A dedicated service class handles form operations:

```php
namespace App\Services;

use App\Models\Form;
use App\Models\FormSubmission;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Validator;

class FormService
{
    /**
     * Process a form submission
     *
     * @param string $formName
     * @param Request $request
     * @return array
     */
    public function processSubmission(string $formName, Request $request)
    {
        // Get the form
        $form = Form::getByName($formName);
        
        if (!$form) {
            return [
                'success' => false,
                'message' => 'Form not found'
            ];
        }
        
        // Validate the form
        $validationRules = [];
        $validationMessages = [];
        
        foreach ($form->fields as $field) {
            $validationRules[$field->name] = $field->getValidationRules();
            
            // Add custom error messages
            if ($field->is_required) {
                $validationMessages[$field->name . '.required'] = "The {$field->label} field is required.";
            }
        }
        
        // Add reCAPTCHA validation if enabled
        if ($form->captcha_enabled) {
            $validationRules['g-recaptcha-response'] = 'required|captcha';
            $validationMessages['g-recaptcha-response.required'] = 'Please verify that you are not a robot.';
            $validationMessages['g-recaptcha-response.captcha'] = 'CAPTCHA verification failed. Please try again.';
        }
        
        $validator = Validator::make($request->all(), $validationRules, $validationMessages);
        
        if ($validator->fails()) {
            return [
                'success' => false,
                'errors' => $validator->errors()
            ];
        }
        
        // Process the submission
        $data = [];
        
        foreach ($form->fields as $field) {
            if ($field->type === 'file' && $request->hasFile($field->name)) {
                $file = $request->file($field->name);
                $path = $file->store('form-uploads', 'public');
                $data[$field->name] = [
                    'filename' => $file->getClientOriginalName(),
                    'path' => $path,
                    'url' => asset('storage/' . $path)
                ];
            } else {
                $data[$field->name] = $request->input($field->name);
            }
        }
        
        // Store the submission if enabled
        if ($form->store_submissions) {
            FormSubmission::create([
                'form_id' => $form->id,
                'data' => $data,
                'ip_address' => $request->ip(),
                'user_agent' => $request->userAgent(),
                'is_read' => false
            ]);
        }
        
        // Send email notifications
        if (!empty($form->email_recipients)) {
            $this->sendNotificationEmail($form, $data);
        }
        
        return [
            'success' => true,
            'message' => $form->success_message ?? 'Form submitted successfully'
        ];
    }
    
    /**
     * Send notification email
     *
     * @param Form $form
     * @param array $data
     * @return void
     */
    protected function sendNotificationEmail(Form $form, array $data)
    {
        Mail::send('emails.form-submission', [
            'form' => $form,
            'data' => $data
        ], function ($message) use ($form) {
            $message->to($form->email_recipients)
                    ->subject("New submission: {$form->title}");
        });
    }
}
```

## Form Component

A Blade component simplifies form rendering in templates:

```php
namespace App\View\Components;

use App\Models\Form;
use Illuminate\View\Component;

class FormRenderer extends Component
{
    public $form;
    public $formName;
    public $showTitle;
    public $showDescription;
    public $submitText;
    
    /**
     * Create a new component instance.
     *
     * @param string $formName
     * @param bool $showTitle
     * @param bool $showDescription
     * @param string $submitText
     * @return void
     */
    public function __construct($formName, $showTitle = true, $showDescription = true, $submitText = 'Submit')
    {
        $this->formName = $formName;
        $this->form = Form::getByName($formName);
        $this->showTitle = $showTitle;
        $this->showDescription = $showDescription;
        $this->submitText = $submitText;
    }
    
    /**
     * Get the view / contents that represent the component.
     *
     * @return \Illuminate\View\View
     */
    public function render()
    {
        return view('theme::components.form-renderer');
    }
}
```

```php
<!-- resources/themes/miata/components/form-renderer.blade.php -->
@if($form)
    <div class="form-container">
        @if($showTitle && $form->title)
            <h3 class="form-title">{{ $form->title }}</h3>
        @endif
        
        @if($showDescription && $form->description)
            <div class="form-description">
                {{ $form->description }}
            </div>
        @endif
        
        <form action="{{ route('form.submit', $form->name) }}" method="POST" enctype="multipart/form-data" class="custom-form">
            @csrf
            <input type="hidden" name="form_name" value="{{ $form->name }}">
            
            @if(session('form_success'))
                <div class="alert alert-success">
                    {{ session('form_success') }}
                </div>
            @endif
            
            @if($errors->any())
                <div class="alert alert-danger">
                    <ul>
                        @foreach($errors->all() as $error)
                            <li>{{ $error }}</li>
                        @endforeach
                    </ul>
                </div>
            @endif
            
            @foreach($form->fields as $field)
                <div class="form-group">
                    @if($field->type !== 'hidden')
                        <label for="{{ $field->name }}">
                            {{ $field->label }}
                            @if($field->is_required)
                                <span class="required">*</span>
                            @endif
                        </label>
                    @endif
                    
                    @switch($field->type)
                        @case('text')
                        @case('email')
                        @case('number')
                        @case('url')
                        @case('date')
                            <input 
                                type="{{ $field->type }}" 
                                name="{{ $field->name }}" 
                                id="{{ $field->name }}" 
                                class="form-control @error($field->name) is-invalid @enderror" 
                                placeholder="{{ $field->placeholder }}" 
                                value="{{ old($field->name, $field->default_value) }}"
                                @if($field->is_required) required @endif
                            >
                            @break
                            
                        @case('textarea')
                            <textarea 
                                name="{{ $field->name }}" 
                                id="{{ $field->name }}" 
                                class="form-control @error($field->name) is-invalid @enderror" 
                                placeholder="{{ $field->placeholder }}" 
                                rows="5"
                                @if($field->is_required) required @endif
                            >{{ old($field->name, $field->default_value) }}</textarea>
                            @break
                            
                        @case('select')
                            <select 
                                name="{{ $field->name }}" 
                                id="{{ $field->name }}" 
                                class="form-control @error($field->name) is-invalid @enderror"
                                @if($field->is_required) required @endif
                            >
                                <option value="">{{ $field->placeholder ?: 'Select an option' }}</option>
                                @foreach($field->options as $value => $label)
                                    <option value="{{ $value }}" {{ old($field->name, $field->default_value) == $value ? 'selected' : '' }}>
                                        {{ $label }}
                                    </option>
                                @endforeach
                            </select>
                            @break
                            
                        @case('checkbox')
                            <div class="form-check">
                                <input 
                                    type="checkbox" 
                                    name="{{ $field->name }}" 
                                    id="{{ $field->name }}" 
                                    class="form-check-input @error($field->name) is-invalid @enderror" 
                                    value="1"
                                    {{ old($field->name, $field->default_value) ? 'checked' : '' }}
                                    @if($field->is_required) required @endif
                                >
                                <label class="form-check-label" for="{{ $field->name }}">
                                    {{ $field->placeholder ?: $field->label }}
                                </label>
                            </div>
                            @break
                            
                        @case('radio')
                            @foreach($field->options as $value => $label)
                                <div class="form-check">
                                    <input 
                                        type="radio" 
                                        name="{{ $field->name }}" 
                                        id="{{ $field->name }}_{{ $value }}" 
                                        class="form-check-input @error($field->name) is-invalid @enderror" 
                                        value="{{ $value }}"
                                        {{ old($field->name, $field->default_value) == $value ? 'checked' : '' }}
                                        @if($field->is_required) required @endif
                                    >
                                    <label class="form-check-label" for="{{ $field->name }}_{{ $value }}">
                                        {{ $label }}
                                    </label>
                                </div>
                            @endforeach
                            @break
                            
                        @case('file')
                            <input 
                                type="file" 
                                name="{{ $field->name }}" 
                                id="{{ $field->name }}" 
                                class="form-control-file @error($field->name) is-invalid @enderror"
                                @if($field->is_required) required @endif
                            >
                            @break
                            
                        @case('hidden')
                            <input 
                                type="hidden" 
                                name="{{ $field->name }}" 
                                id="{{ $field->name }}" 
                                value="{{ old($field->name, $field->default_value) }}"
                            >
                            @break
                    @endswitch
                    
                    @if($field->help_text)
                        <small class="form-text text-muted">{{ $field->help_text }}</small>
                    @endif
                    
                    @error($field->name)
                        <div class="invalid-feedback">
                            {{ $message }}
                        </div>
                    @enderror
                </div>
            @endforeach
            
            @if($form->captcha_enabled)
                <div class="form-group">
                    {!! NoCaptcha::display() !!}
                    @error('g-recaptcha-response')
                        <div class="invalid-feedback d-block">
                            {{ $message }}
                        </div>
                    @enderror
                </div>
            @endif
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">{{ $submitText }}</button>
            </div>
        </form>
    </div>
@else
    <div class="alert alert-warning">
        Form not found: {{ $formName }}
    </div>
@endif

@if($form && $form->captcha_enabled)
    @push('scripts')
        {!! NoCaptcha::renderJs() !!}
    @endpush
@endif
```

## Form Controller

A controller handles form submissions:

```php
namespace App\Http\Controllers;

use App\Services\FormService;
use Illuminate\Http\Request;

class FormController extends Controller
{
    protected $formService;
    
    /**
     * Create a new controller instance.
     *
     * @param FormService $formService
     * @return void
     */
    public function __construct(FormService $formService)
    {
        $this->formService = $formService;
    }
    
    /**
     * Handle form submission
     *
     * @param Request $request
     * @return \Illuminate\Http\Response
     */
    public function submit(Request $request)
    {
        $formName = $request->input('form_name');
        
        if (!$formName) {
            return redirect()->back()->withErrors(['form_name' => 'Form name is required']);
        }
        
        $result = $this->formService->processSubmission($formName, $request);
        
        if (!$result['success']) {
            return redirect()->back()->withErrors($result['errors'] ?? ['error' => $result['message']]);
        }
        
        return redirect()->back()->with('form_success', $result['message']);
    }
}
```

## Form Routes

Routes for form submission:

```php
// routes/web.php

// Form submission
Route::post('/form/submit', [App\Http\Controllers\FormController::class, 'submit'])->name('form.submit');
```

## Ajax Form Submission

For Ajax form submissions, a JavaScript handler can be added:

```javascript
// resources/themes/miata/js/form-handler.js
$(document).ready(function() {
    $('.ajax-form').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const submitButton = form.find('button[type="submit"]');
        const formData = new FormData(this);
        
        // Disable submit button
        submitButton.prop('disabled', true);
        
        // Remove previous alerts
        form.find('.alert').remove();
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                // Show success message
                form.prepend('<div class="alert alert-success">' + response.message + '</div>');
                
                // Reset form
                form[0].reset();
                
                // Enable submit button
                submitButton.prop('disabled', false);
            },
            error: function(xhr) {
                // Show error message
                if (xhr.responseJSON && xhr.responseJSON.errors) {
                    let errorHtml = '<div class="alert alert-danger"><ul>';
                    
                    for (const field in xhr.responseJSON.errors) {
                        xhr.responseJSON.errors[field].forEach(function(error) {
                            errorHtml += '<li>' + error + '</li>';
                        });
                    }
                    
                    errorHtml += '</ul></div>';
                    form.prepend(errorHtml);
                } else {
                    form.prepend('<div class="alert alert-danger">An error occurred. Please try again.</div>');
                }
                
                // Enable submit button
                submitButton.prop('disabled', false);
            }
        });
    });
});
```

## Conclusion

The form handling system provides a flexible way to create and manage forms in the CMS. By using the `Form` and `FormField` models, forms can be created with various field types and validation rules. The system supports file uploads, CAPTCHA verification, and email notifications. The implementation is designed to work seamlessly with the Miata template while providing a robust backend architecture for form management.

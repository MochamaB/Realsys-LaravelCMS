# Frontend - Widget Rendering

This document outlines the widget rendering system for the CMS, explaining how widgets are displayed within page sections.

## Widget Rendering Process

The widget rendering process involves several steps:

1. **Widget Loading**: Widgets are loaded for a specific page section
2. **Data Assembly**: Widget data is assembled from the database
3. **Component Selection**: The appropriate component is selected based on the widget type
4. **Rendering**: The component is rendered with the widget data

## Widget Model Rendering Method

The `Widget` model includes a `render()` method that handles the rendering process:

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\View;

class Widget extends Model
{
    // ... other properties and methods ...
    
    /**
     * Render the widget
     *
     * @return string
     */
    public function render()
    {
        if (!$this->is_active) {
            return '';
        }
        
        $data = $this->getData();
        $componentPath = $this->widgetType->component_path;
        
        if (!View::exists($componentPath)) {
            return "<!-- Widget component not found: {$componentPath} -->";
        }
        
        return view($componentPath, [
            'widget' => $this,
            'data' => $data
        ])->render();
    }
    
    /**
     * Get all data for this widget in a structured format
     *
     * @return array
     */
    public function getData()
    {
        $data = [];
        
        foreach ($this->widgetType->fields as $field) {
            if ($field->is_repeatable) {
                $data[$field->name] = $this->getRepeaterValues($field->id);
            } else {
                $data[$field->name] = $this->getValue($field->name);
            }
        }
        
        return $data;
    }
    
    // ... other methods ...
}
```

## Widget Components

Widget components are Blade templates that render the widget content:

```php
<!-- resources/themes/miata/components/widgets/slider.blade.php -->
@props(['widget', 'data'])

<div class="slider-widget">
    @if(isset($data['title']))
        <div class="section-title">
            <h2>{{ $data['title'] }}</h2>
            @if(isset($data['description']))
                <p>{{ $data['description'] }}</p>
            @endif
        </div>
    @endif
    
    @if(isset($data['slides']) && is_array($data['slides']) && count($data['slides']) > 0)
        <div class="hero-slider">
            @foreach($data['slides'] as $slide)
                <div class="single-slide">
                    <div class="row align-items-center">
                        <div class="col-lg-6">
                            <div class="slide-content">
                                @if(isset($slide['title']))
                                    <h1>{{ $slide['title'] }}</h1>
                                @endif
                                
                                @if(isset($slide['description']))
                                    <p>{{ $slide['description'] }}</p>
                                @endif
                                
                                @if(isset($slide['button_text']) && isset($slide['button_url']))
                                    <a href="{{ $slide['button_url'] }}" class="btn btn-primary">{{ $slide['button_text'] }}</a>
                                @endif
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="slide-image">
                                @if(isset($slide['image']))
                                    <img src="{{ asset('storage/' . $slide['image']) }}" alt="{{ $slide['title'] ?? 'Slide Image' }}">
                                @endif
                            </div>
                        </div>
                    </div>
                </div>
            @endforeach
        </div>
    @endif
</div>

@push('scripts')
<script>
    $(document).ready(function() {
        $('.hero-slider').slick({
            dots: true,
            arrows: true,
            infinite: true,
            speed: 500,
            fade: true,
            cssEase: 'linear',
            autoplay: true,
            autoplaySpeed: 5000
        });
    });
</script>
@endpush
```

```php
<!-- resources/themes/miata/components/widgets/team.blade.php -->
@props(['widget', 'data'])

<div class="team-widget">
    @if(isset($data['title']))
        <div class="section-title">
            <h2>{{ $data['title'] }}</h2>
            @if(isset($data['description']))
                <p>{{ $data['description'] }}</p>
            @endif
        </div>
    @endif
    
    @if(isset($data['members']) && is_array($data['members']) && count($data['members']) > 0)
        <div class="row">
            @foreach($data['members'] as $member)
                <div class="col-lg-4 col-md-6">
                    <div class="team-member">
                        <div class="member-image">
                            @if(isset($member['image']))
                                <img src="{{ asset('storage/' . $member['image']) }}" alt="{{ $member['name'] ?? 'Team Member' }}">
                            @endif
                        </div>
                        <div class="member-info">
                            @if(isset($member['name']))
                                <h4>{{ $member['name'] }}</h4>
                            @endif
                            
                            @if(isset($member['position']))
                                <p class="position">{{ $member['position'] }}</p>
                            @endif
                            
                            @if(isset($member['bio']))
                                <p class="bio">{{ $member['bio'] }}</p>
                            @endif
                            
                            @if(isset($member['social_links']) && is_array($member['social_links']))
                                <div class="social-links">
                                    @foreach($member['social_links'] as $platform => $url)
                                        <a href="{{ $url }}"><i class="fab fa-{{ $platform }}"></i></a>
                                    @endforeach
                                </div>
                            @endif
                        </div>
                    </div>
                </div>
            @endforeach
        </div>
    @endif
</div>
```

```php
<!-- resources/themes/miata/components/widgets/counter.blade.php -->
@props(['widget', 'data'])

<div class="counter-widget">
    @if(isset($data['title']))
        <div class="section-title">
            <h2>{{ $data['title'] }}</h2>
            @if(isset($data['description']))
                <p>{{ $data['description'] }}</p>
            @endif
        </div>
    @endif
    
    @if(isset($data['stats']) && is_array($data['stats']) && count($data['stats']) > 0)
        <div class="row">
            @foreach($data['stats'] as $stat)
                <div class="col-lg-3 col-md-6">
                    <div class="counter-item">
                        @if(isset($stat['icon']))
                            <div class="counter-icon">
                                <i class="{{ $stat['icon'] }}"></i>
                            </div>
                        @endif
                        
                        <div class="counter-content">
                            @if(isset($stat['value']))
                                <h3 class="counter-value">{{ $stat['value'] }}</h3>
                            @endif
                            
                            @if(isset($stat['title']))
                                <p class="counter-title">{{ $stat['title'] }}</p>
                            @endif
                        </div>
                    </div>
                </div>
            @endforeach
        </div>
    @endif
</div>

@push('scripts')
<script>
    $(document).ready(function() {
        $('.counter-value').each(function() {
            $(this).prop('Counter', 0).animate({
                Counter: $(this).text()
            }, {
                duration: 3000,
                easing: 'swing',
                step: function(now) {
                    $(this).text(Math.ceil(now));
                }
            });
        });
    });
</script>
@endpush
```

## Widget Rendering Service

A dedicated service class can handle more complex widget rendering operations:

```php
namespace App\Services;

use App\Models\Widget;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\View;

class WidgetRenderingService
{
    /**
     * Render a widget with caching
     *
     * @param Widget $widget
     * @param int $cacheDuration Minutes to cache the widget
     * @return string
     */
    public function renderCached(Widget $widget, $cacheDuration = 60)
    {
        if (!$widget->is_active) {
            return '';
        }
        
        // Generate cache key
        $cacheKey = "widget_{$widget->id}_" . app()->getLocale();
        
        // Check if widget is cached
        if (Cache::has($cacheKey)) {
            return Cache::get($cacheKey);
        }
        
        // Render the widget
        $rendered = $this->render($widget);
        
        // Cache the rendered widget
        Cache::put($cacheKey, $rendered, $cacheDuration * 60);
        
        return $rendered;
    }
    
    /**
     * Render a widget
     *
     * @param Widget $widget
     * @return string
     */
    public function render(Widget $widget)
    {
        if (!$widget->is_active) {
            return '';
        }
        
        $data = $widget->getData();
        $componentPath = $widget->widgetType->component_path;
        
        if (!View::exists($componentPath)) {
            return "<!-- Widget component not found: {$componentPath} -->";
        }
        
        return view($componentPath, [
            'widget' => $widget,
            'data' => $data
        ])->render();
    }
    
    /**
     * Render widgets for a page section
     *
     * @param \App\Models\Page $page
     * @param string $sectionSlug
     * @param bool $useCache
     * @return string
     */
    public function renderPageSection($page, $sectionSlug, $useCache = true)
    {
        $widgets = $page->getWidgetsBySection($sectionSlug);
        $output = '';
        
        foreach ($widgets as $widget) {
            if ($useCache) {
                $output .= $this->renderCached($widget);
            } else {
                $output .= $this->render($widget);
            }
        }
        
        return $output;
    }
}
```

## Widget Data Processing

Some widgets may require additional data processing before rendering:

```php
namespace App\Services;

use App\Models\Widget;

class WidgetDataProcessor
{
    /**
     * Process widget data before rendering
     *
     * @param Widget $widget
     * @param array $data
     * @return array
     */
    public function processData(Widget $widget, array $data)
    {
        $widgetType = $widget->widgetType;
        
        // Process data based on widget type
        switch ($widgetType->slug) {
            case 'latest-posts':
                return $this->processLatestPostsData($data);
            
            case 'gallery':
                return $this->processGalleryData($data);
            
            case 'contact-form':
                return $this->processContactFormData($data);
            
            default:
                return $data;
        }
    }
    
    /**
     * Process latest posts widget data
     *
     * @param array $data
     * @return array
     */
    protected function processLatestPostsData(array $data)
    {
        // Get number of posts to display
        $limit = $data['limit'] ?? 3;
        
        // Get category if specified
        $category = $data['category'] ?? null;
        
        // Get latest posts
        $postsQuery = \App\Models\Page::where('is_active', true)
            ->orderBy('created_at', 'desc');
            
        if ($category) {
            $postsQuery->where('category', $category);
        }
        
        $posts = $postsQuery->take($limit)->get();
        
        // Add posts to data
        $data['posts'] = $posts;
        
        return $data;
    }
    
    /**
     * Process gallery widget data
     *
     * @param array $data
     * @return array
     */
    protected function processGalleryData(array $data)
    {
        // Process gallery images
        if (isset($data['images']) && is_array($data['images'])) {
            foreach ($data['images'] as &$image) {
                // Generate thumbnail URL
                if (isset($image['image'])) {
                    $image['thumbnail'] = $this->generateThumbnail($image['image']);
                }
            }
        }
        
        return $data;
    }
    
    /**
     * Process contact form widget data
     *
     * @param array $data
     * @return array
     */
    protected function processContactFormData(array $data)
    {
        // Add CSRF token
        $data['csrf_token'] = csrf_token();
        
        // Add form action URL
        $data['form_action'] = route('contact.submit');
        
        return $data;
    }
    
    /**
     * Generate thumbnail URL for an image
     *
     * @param string $imagePath
     * @return string
     */
    protected function generateThumbnail($imagePath)
    {
        // In a real implementation, this would generate or return a thumbnail URL
        // For simplicity, we'll just return the original image path
        return $imagePath;
    }
}
```

## Widget JavaScript Initialization

Some widgets require JavaScript initialization. This can be handled using Laravel's stack system:

```php
<!-- resources/themes/miata/layouts/default.blade.php -->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... head content ... -->
    @stack('styles')
</head>
<body>
    <!-- ... body content ... -->
    
    <!-- JS Files -->
    <script src="{{ theme_asset('js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ theme_asset('js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ theme_asset('js/slick.min.js') }}"></script>
    <script src="{{ theme_asset('js/jquery.nice-select.min.js') }}"></script>
    <script src="{{ theme_asset('js/wow.min.js') }}"></script>
    <script src="{{ theme_asset('js/main.js') }}"></script>
    
    @stack('scripts')
</body>
</html>
```

Widget components can then push their JavaScript initialization to the scripts stack:

```php
<!-- resources/themes/miata/components/widgets/gallery.blade.php -->
@props(['widget', 'data'])

<div class="gallery-widget">
    <!-- ... widget content ... -->
</div>

@push('scripts')
<script>
    $(document).ready(function() {
        $('.gallery-widget .gallery-items').magnificPopup({
            delegate: 'a',
            type: 'image',
            gallery: {
                enabled: true
            }
        });
    });
</script>
@endpush
```

## Conclusion

The widget rendering system provides a flexible way to display dynamic content within page sections. By using Blade components and a service-oriented architecture, widgets can be rendered with custom data processing and JavaScript initialization. The system supports caching for improved performance and allows for easy customization of widget appearance and behavior.

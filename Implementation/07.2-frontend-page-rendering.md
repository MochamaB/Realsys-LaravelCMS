# Frontend - Page Rendering

This document outlines the page rendering system for the CMS, explaining how pages are loaded and rendered from the database.

## Page Rendering Process

The page rendering process involves several steps:

1. **Route Handling**: The request is routed to the appropriate controller
2. **Page Loading**: The page is loaded from the database
3. **Template Selection**: The appropriate template is selected based on the page's template_id
4. **Content Assembly**: The page content and widgets are assembled
5. **Rendering**: The template is rendered with the assembled content

## Route Handling

The main route for handling page requests is defined in `routes/web.php`:

```php
// Dynamic page routes
Route::get('/', [PageController::class, 'show'])->name('home');
Route::get('/{slug}', [PageController::class, 'show'])->name('page.show')->where('slug', '[a-z0-9-]+');
```

## Page Controller

The `PageController` handles the loading and rendering of pages:

```php
namespace App\Http\Controllers;

use App\Models\Page;
use App\Models\Menu;
use App\Models\Theme;
use App\Services\PageRenderingService;
use Illuminate\Http\Request;

class PageController extends Controller
{
    protected $pageRenderingService;
    
    /**
     * Create a new controller instance.
     *
     * @param PageRenderingService $pageRenderingService
     * @return void
     */
    public function __construct(PageRenderingService $pageRenderingService)
    {
        $this->pageRenderingService = $pageRenderingService;
    }
    
    /**
     * Display the specified page.
     *
     * @param  string  $slug
     * @return \Illuminate\Http\Response
     */
    public function show($slug = 'home')
    {
        // Load the page
        $page = Page::where('slug', $slug)
                    ->where('is_active', true)
                    ->firstOrFail();
        
        // Get menus
        $mainMenu = Menu::getByLocation('main');
        $footerMenu = Menu::getByLocation('footer');
        
        // Get the active theme
        $theme = Theme::where('is_active', true)->firstOrFail();
        
        // Get the template
        $template = $page->template;
        
        if (!$template) {
            abort(500, 'Page template not found');
        }
        
        // Prepare view data
        $viewData = [
            'page' => $page,
            'mainMenu' => $mainMenu,
            'footerMenu' => $footerMenu,
            'theme' => $theme
        ];
        
        // Add breadcrumbs if not home page
        if ($slug !== 'home') {
            $viewData['breadcrumbs'] = $this->pageRenderingService->generateBreadcrumbs($page);
        }
        
        // Render the page
        return view("theme::templates.{$template->slug}", $viewData);
    }
}
```

## Page Rendering Service

The `PageRenderingService` handles the assembly and preparation of page content:

```php
namespace App\Services;

use App\Models\Page;
use Illuminate\Support\Collection;

class PageRenderingService
{
    /**
     * Generate breadcrumbs for a page
     *
     * @param Page $page
     * @return Collection
     */
    public function generateBreadcrumbs(Page $page)
    {
        $breadcrumbs = collect();
        
        // Add home page
        $breadcrumbs->push([
            'title' => 'Home',
            'url' => route('home')
        ]);
        
        // If page has parent, add parent pages
        if ($page->parent_id) {
            $this->addParentBreadcrumbs($breadcrumbs, $page->parent);
        }
        
        // Add current page
        $breadcrumbs->push([
            'title' => $page->title,
            'url' => route('page.show', $page->slug),
            'active' => true
        ]);
        
        return $breadcrumbs;
    }
    
    /**
     * Add parent pages to breadcrumbs
     *
     * @param Collection $breadcrumbs
     * @param Page $parent
     * @return void
     */
    protected function addParentBreadcrumbs(Collection $breadcrumbs, Page $parent)
    {
        if ($parent->parent_id) {
            $this->addParentBreadcrumbs($breadcrumbs, $parent->parent);
        }
        
        $breadcrumbs->push([
            'title' => $parent->title,
            'url' => route('page.show', $parent->slug)
        ]);
    }
    
    /**
     * Get related pages for a page
     *
     * @param Page $page
     * @param int $limit
     * @return Collection
     */
    public function getRelatedPages(Page $page, $limit = 3)
    {
        // Get pages with the same parent
        if ($page->parent_id) {
            $relatedPages = Page::where('parent_id', $page->parent_id)
                ->where('id', '!=', $page->id)
                ->where('is_active', true)
                ->take($limit)
                ->get();
                
            if ($relatedPages->count() >= $limit) {
                return $relatedPages;
            }
        }
        
        // If not enough related pages, get recent pages
        $remainingLimit = $limit - ($relatedPages->count() ?? 0);
        
        $recentPages = Page::where('id', '!=', $page->id)
            ->where('is_active', true)
            ->orderBy('created_at', 'desc')
            ->take($remainingLimit)
            ->get();
            
        return collect([$relatedPages ?? collect(), $recentPages])->flatten()->unique('id');
    }
}
```

## Template Structure

Templates define the structure of the page and include sections for widgets:

```php
<!-- resources/themes/miata/templates/default.blade.php -->
{{-- 
name: Default Page
description: Default template for content pages
sections: hero, content, sidebar
--}}

@extends('theme::layouts.default')

@section('content')
    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-title">{{ $page->title }}</h1>
                    
                    @if(isset($breadcrumbs))
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                @foreach($breadcrumbs as $breadcrumb)
                                    <li class="breadcrumb-item {{ $breadcrumb['active'] ?? false ? 'active' : '' }}">
                                        @if($breadcrumb['active'] ?? false)
                                            {{ $breadcrumb['title'] }}
                                        @else
                                            <a href="{{ $breadcrumb['url'] }}">{{ $breadcrumb['title'] }}</a>
                                        @endif
                                    </li>
                                @endforeach
                            </ol>
                        </nav>
                    @endif
                </div>
            </div>
        </div>
    </section>
    
    <!-- Hero Section -->
    @if($page->getWidgetsBySection('hero')->count() > 0)
        <section class="hero-section">
            <div class="container">
                @foreach($page->getWidgetsBySection('hero') as $widget)
                    {!! $widget->render() !!}
                @endforeach
            </div>
        </section>
    @endif
    
    <!-- Content Section -->
    <section class="content-section section-padding">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Content Widgets -->
                    @foreach($page->getWidgetsBySection('content') as $widget)
                        {!! $widget->render() !!}
                    @endforeach
                    
                    <!-- Page Content -->
                    @if($page->content)
                        <div class="page-content">
                            {!! $page->content !!}
                        </div>
                    @endif
                </div>
                
                <div class="col-lg-4">
                    <!-- Sidebar Widgets -->
                    @foreach($page->getWidgetsBySection('sidebar') as $widget)
                        {!! $widget->render() !!}
                    @endforeach
                </div>
            </div>
        </div>
    </section>
@endsection
```

## Dynamic Content Sections

Templates include sections for widgets, which are rendered dynamically based on the page's content:

```php
<!-- Widget Section Example -->
<section class="team-section section-padding">
    <div class="container">
        <div class="section-title">
            <h2>Our Team</h2>
            <p>Meet our dedicated team of professionals</p>
        </div>
        
        <div class="row">
            @foreach($page->getWidgetsBySection('team') as $widget)
                {!! $widget->render() !!}
            @endforeach
        </div>
    </div>
</section>
```

## Error Handling

When a page is not found, a 404 error is returned:

```php
// resources/views/errors/404.blade.php
@extends('theme::layouts.default')

@section('content')
    <section class="error-section section-padding">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <div class="error-content">
                        <h1>404</h1>
                        <h2>Page Not Found</h2>
                        <p>The page you are looking for might have been removed, had its name changed, or is temporarily unavailable.</p>
                        <a href="{{ route('home') }}" class="btn btn-primary">Back to Home</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
@endsection
```

## Page Caching

To improve performance, pages can be cached:

```php
namespace App\Http\Controllers;

use App\Models\Page;
use App\Models\Menu;
use App\Models\Theme;
use App\Services\PageRenderingService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Cache;

class PageController extends Controller
{
    // ... other methods ...
    
    /**
     * Display the specified page with caching.
     *
     * @param  string  $slug
     * @return \Illuminate\Http\Response
     */
    public function showCached($slug = 'home')
    {
        // Generate cache key
        $cacheKey = "page_{$slug}_" . app()->getLocale();
        
        // Check if page is cached
        if (Cache::has($cacheKey)) {
            return Cache::get($cacheKey);
        }
        
        // Load and render the page
        $response = $this->show($slug);
        
        // Cache the response for 1 hour
        Cache::put($cacheKey, $response, 60 * 60);
        
        return $response;
    }
}
```

## Conclusion

The page rendering system provides a flexible way to display content managed through the CMS. By leveraging Laravel's templating system and the theme architecture, pages can be rendered with dynamic content while maintaining a consistent design. The system supports features like breadcrumbs, related pages, and caching for improved performance.

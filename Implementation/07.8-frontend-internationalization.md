# Frontend - Internationalization and Localization

This document outlines the internationalization (i18n) and localization (l10n) system for the CMS, explaining how multilingual content is managed and rendered on the frontend.

## Internationalization Overview

The internationalization system consists of several components:

1. **Language Management**: Handling multiple languages in the CMS
2. **Content Translation**: Translating pages, widgets, and other content
3. **URL Localization**: Managing localized URLs
4. **Language Switching**: Allowing users to switch between languages
5. **RTL Support**: Supporting right-to-left languages

## Language Configuration

Laravel's built-in localization features are used as the foundation:

```php
// config/app.php

return [
    // ...
    
    'locale' => env('APP_LOCALE', 'en'),
    
    'fallback_locale' => 'en',
    
    'available_locales' => [
        'en' => [
            'name' => 'English',
            'native' => 'English',
            'flag' => 'gb',
            'direction' => 'ltr',
        ],
        'sw' => [
            'name' => 'Swahili',
            'native' => 'Kiswahili',
            'flag' => 'ke',
            'direction' => 'ltr',
        ],
        'ar' => [
            'name' => 'Arabic',
            'native' => 'العربية',
            'flag' => 'sa',
            'direction' => 'rtl',
        ],
    ],
];
```

## Language Middleware

A middleware handles language detection and switching:

```php
namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\App;
use Illuminate\Support\Facades\Session;

class LocaleMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle(Request $request, Closure $next)
    {
        // Get the locale from the URL
        $locale = $request->segment(1);
        
        // Check if the locale is valid
        if ($locale && array_key_exists($locale, config('app.available_locales'))) {
            App::setLocale($locale);
            Session::put('locale', $locale);
        } else {
            // If no valid locale in URL, use the session or browser locale
            $locale = Session::get('locale', $this->getBrowserLocale($request));
            
            if ($locale && array_key_exists($locale, config('app.available_locales'))) {
                App::setLocale($locale);
                Session::put('locale', $locale);
            }
        }
        
        // Share the current locale with all views
        view()->share('currentLocale', App::getLocale());
        view()->share('availableLocales', config('app.available_locales'));
        
        return $next($request);
    }
    
    /**
     * Get the browser locale
     *
     * @param  \Illuminate\Http\Request  $request
     * @return string|null
     */
    protected function getBrowserLocale(Request $request)
    {
        $locale = $request->server('HTTP_ACCEPT_LANGUAGE');
        
        if (!$locale) {
            return null;
        }
        
        $locale = substr($locale, 0, 2);
        
        return array_key_exists($locale, config('app.available_locales')) ? $locale : null;
    }
}
```

Register the middleware in the `Kernel.php` file:

```php
protected $middlewareGroups = [
    'web' => [
        // ... other middleware
        \App\Http\Middleware\LocaleMiddleware::class,
    ],
];
```

## Translatable Models

Models that need to be translated use a trait:

```php
namespace App\Traits;

use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Facades\App;

trait Translatable
{
    /**
     * Get the translatable attributes
     *
     * @return array
     */
    public function getTranslatableAttributes(): array
    {
        return $this->translatable ?? [];
    }
    
    /**
     * Boot the translatable trait
     *
     * @return void
     */
    public static function bootTranslatable()
    {
        static::retrieved(function ($model) {
            $model->setTranslations();
        });
    }
    
    /**
     * Set translations for translatable attributes
     *
     * @return void
     */
    public function setTranslations()
    {
        $locale = App::getLocale();
        $fallbackLocale = config('app.fallback_locale');
        
        foreach ($this->getTranslatableAttributes() as $attribute) {
            $translations = $this->getAttributeValue($attribute);
            
            if (is_array($translations)) {
                // If the attribute is already an array of translations
                if (isset($translations[$locale])) {
                    $this->attributes[$attribute] = $translations[$locale];
                } elseif (isset($translations[$fallbackLocale])) {
                    $this->attributes[$attribute] = $translations[$fallbackLocale];
                }
            }
        }
    }
    
    /**
     * Get a translated attribute
     *
     * @param string $attribute
     * @param string|null $locale
     * @return mixed
     */
    public function getTranslated($attribute, $locale = null)
    {
        $locale = $locale ?: App::getLocale();
        $fallbackLocale = config('app.fallback_locale');
        
        $translations = $this->getAttributeValue($attribute);
        
        if (is_array($translations)) {
            if (isset($translations[$locale])) {
                return $translations[$locale];
            } elseif (isset($translations[$fallbackLocale])) {
                return $translations[$fallbackLocale];
            }
        }
        
        return $translations;
    }
    
    /**
     * Set a translated attribute
     *
     * @param string $attribute
     * @param mixed $value
     * @param string|null $locale
     * @return $this
     */
    public function setTranslated($attribute, $value, $locale = null)
    {
        $locale = $locale ?: App::getLocale();
        
        $translations = $this->getAttributeValue($attribute);
        
        if (!is_array($translations)) {
            $translations = [];
        }
        
        $translations[$locale] = $value;
        
        $this->attributes[$attribute] = json_encode($translations);
        
        return $this;
    }
    
    /**
     * Scope a query to include only models with a translation
     *
     * @param Builder $query
     * @param string|null $locale
     * @return Builder
     */
    public function scopeWithTranslation(Builder $query, $locale = null)
    {
        $locale = $locale ?: App::getLocale();
        
        return $query->where(function ($query) use ($locale) {
            foreach ($this->getTranslatableAttributes() as $attribute) {
                $query->orWhere($attribute, 'LIKE', '%"' . $locale . '"%');
            }
        });
    }
}
```

Example usage in the `Page` model:

```php
namespace App\Models;

use App\Traits\Translatable;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

class Page extends Model
{
    use Translatable;
    
    protected $fillable = [
        'parent_id',
        'template_id',
        'title',
        'slug',
        'description',
        'content',
        'meta_title',
        'meta_description',
        'meta_keywords',
        'is_active',
        'order_index'
    ];
    
    protected $casts = [
        'is_active' => 'boolean',
        'title' => 'array',
        'description' => 'array',
        'content' => 'array',
        'meta_title' => 'array',
        'meta_description' => 'array',
        'meta_keywords' => 'array'
    ];
    
    protected $translatable = [
        'title',
        'description',
        'content',
        'meta_title',
        'meta_description',
        'meta_keywords'
    ];
    
    // ... other methods and relationships ...
    
    /**
     * Get the page's title
     *
     * @param string|null $locale
     * @return string
     */
    public function getTitle($locale = null)
    {
        return $this->getTranslated('title', $locale);
    }
    
    /**
     * Get the page's content
     *
     * @param string|null $locale
     * @return string
     */
    public function getContent($locale = null)
    {
        return $this->getTranslated('content', $locale);
    }
    
    /**
     * Generate a localized slug
     *
     * @param string $title
     * @param string $locale
     * @return string
     */
    public function generateLocalizedSlug($title, $locale)
    {
        $slug = Str::slug($title);
        
        // If this is not the default locale, add the locale to the slug
        if ($locale !== config('app.fallback_locale')) {
            $slug = "{$locale}-{$slug}";
        }
        
        // Check if the slug already exists
        $count = 1;
        $originalSlug = $slug;
        
        while (self::where('slug', $slug)->where('id', '!=', $this->id)->exists()) {
            $slug = "{$originalSlug}-{$count}";
            $count++;
        }
        
        return $slug;
    }
}
```

## Localized Routes

Routes are configured to handle localization:

```php
// routes/web.php

// Localized routes
Route::group(['prefix' => '{locale?}', 'where' => ['locale' => '[a-z]{2}']], function () {
    // Home page
    Route::get('/', [App\Http\Controllers\Frontend\PageController::class, 'home'])->name('home');
    
    // Pages
    Route::get('/{slug}', [App\Http\Controllers\Frontend\PageController::class, 'show'])->name('page.show');
    
    // Contact form
    Route::post('/contact', [App\Http\Controllers\Frontend\ContactController::class, 'submit'])->name('contact.submit');
});

// Language switcher
Route::get('/language/{locale}', [App\Http\Controllers\LanguageController::class, 'switch'])->name('language.switch');
```

## Language Controller

A controller handles language switching:

```php
namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Session;

class LanguageController extends Controller
{
    /**
     * Switch the language
     *
     * @param Request $request
     * @param string $locale
     * @return \Illuminate\Http\RedirectResponse
     */
    public function switch(Request $request, $locale)
    {
        // Check if the locale is valid
        if (!array_key_exists($locale, config('app.available_locales'))) {
            $locale = config('app.fallback_locale');
        }
        
        // Store the locale in the session
        Session::put('locale', $locale);
        
        // Redirect back to the previous page
        return redirect()->back();
    }
}
```

## Language Switcher Component

A Blade component for language switching:

```php
namespace App\View\Components;

use Illuminate\View\Component;

class LanguageSwitcher extends Component
{
    public $currentUrl;
    
    /**
     * Create a new component instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->currentUrl = url()->current();
    }
    
    /**
     * Get the view / contents that represent the component.
     *
     * @return \Illuminate\View\View
     */
    public function render()
    {
        return view('theme::components.language-switcher');
    }
    
    /**
     * Get the URL for a locale
     *
     * @param string $locale
     * @return string
     */
    public function getLocaleUrl($locale)
    {
        $currentLocale = app()->getLocale();
        $baseUrl = url('/');
        $currentPath = str_replace($baseUrl, '', $this->currentUrl);
        
        // If the current URL starts with the current locale, replace it with the new locale
        if (strpos($currentPath, "/{$currentLocale}") === 0) {
            return $baseUrl . str_replace("/{$currentLocale}", "/{$locale}", $currentPath);
        }
        
        // Otherwise, add the locale to the URL
        return $baseUrl . "/{$locale}" . $currentPath;
    }
}
```

```php
<!-- resources/themes/miata/components/language-switcher.blade.php -->
<div class="language-switcher">
    <div class="dropdown">
        <button class="btn btn-sm dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="flag-icon flag-icon-{{ config('app.available_locales')[app()->getLocale()]['flag'] }}"></span>
            {{ config('app.available_locales')[app()->getLocale()]['native'] }}
        </button>
        <ul class="dropdown-menu" aria-labelledby="languageDropdown">
            @foreach(config('app.available_locales') as $locale => $properties)
                <li>
                    <a class="dropdown-item {{ $locale === app()->getLocale() ? 'active' : '' }}" href="{{ $getLocaleUrl($locale) }}">
                        <span class="flag-icon flag-icon-{{ $properties['flag'] }}"></span>
                        {{ $properties['native'] }}
                    </a>
                </li>
            @endforeach
        </ul>
    </div>
</div>
```

## Localized URLs Helper

A helper function for generating localized URLs:

```php
namespace App\Helpers;

use Illuminate\Support\Facades\App;
use Illuminate\Support\Facades\URL;

class LocalizationHelper
{
    /**
     * Get a localized URL
     *
     * @param string $name
     * @param array $parameters
     * @param string|null $locale
     * @return string
     */
    public static function route($name, $parameters = [], $locale = null)
    {
        $locale = $locale ?: App::getLocale();
        
        // Add locale to parameters
        $parameters = array_merge(['locale' => $locale], $parameters);
        
        return route($name, $parameters);
    }
    
    /**
     * Get a localized URL for a page
     *
     * @param \App\Models\Page $page
     * @param string|null $locale
     * @return string
     */
    public static function pageUrl($page, $locale = null)
    {
        $locale = $locale ?: App::getLocale();
        
        return self::route('page.show', ['slug' => $page->slug], $locale);
    }
    
    /**
     * Get the current URL in a different locale
     *
     * @param string $locale
     * @return string
     */
    public static function currentUrlInLocale($locale)
    {
        $currentLocale = App::getLocale();
        $currentUrl = URL::current();
        $baseUrl = url('/');
        
        // If the current URL starts with the current locale, replace it with the new locale
        if (strpos($currentUrl, "{$baseUrl}/{$currentLocale}") === 0) {
            return str_replace("{$baseUrl}/{$currentLocale}", "{$baseUrl}/{$locale}", $currentUrl);
        }
        
        // If the current URL doesn't have a locale prefix, add the new locale
        return "{$baseUrl}/{$locale}" . str_replace($baseUrl, '', $currentUrl);
    }
}
```

## RTL Support

Support for right-to-left languages is added to the layout:

```php
<!-- resources/themes/miata/layouts/default.blade.php -->
<!DOCTYPE html>
<html lang="{{ app()->getLocale() }}" dir="{{ config('app.available_locales')[app()->getLocale()]['direction'] }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{{ $page->getTranslated('meta_title') ?? $page->getTranslated('title') }} - {{ config('app.name') }}</title>
    
    <!-- Meta Description -->
    <meta name="description" content="{{ $page->getTranslated('meta_description') }}">
    
    <!-- Meta Keywords -->
    @if($page->getTranslated('meta_keywords'))
        <meta name="keywords" content="{{ $page->getTranslated('meta_keywords') }}">
    @endif
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ url()->current() }}">
    
    <!-- Alternate language URLs -->
    @foreach(config('app.available_locales') as $locale => $properties)
        <link rel="alternate" hreflang="{{ $locale }}" href="{{ \App\Helpers\LocalizationHelper::currentUrlInLocale($locale) }}">
    @endforeach
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ theme_asset('css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ theme_asset('css/fontawesome.min.css') }}">
    <link rel="stylesheet" href="{{ theme_asset('css/flag-icon.min.css') }}">
    
    <!-- RTL CSS -->
    @if(config('app.available_locales')[app()->getLocale()]['direction'] === 'rtl')
        <link rel="stylesheet" href="{{ theme_asset('css/bootstrap-rtl.min.css') }}">
        <link rel="stylesheet" href="{{ theme_asset('css/style-rtl.css') }}">
    @else
        <link rel="stylesheet" href="{{ theme_asset('css/style.css') }}">
    @endif
    
    @stack('styles')
</head>
<body class="lang-{{ app()->getLocale() }} {{ config('app.available_locales')[app()->getLocale()]['direction'] === 'rtl' ? 'rtl' : 'ltr' }}">
    <!-- ... body content ... -->
    
    <!-- Language Switcher -->
    <x-language-switcher />
    
    <!-- JS Files -->
    <script src="{{ theme_asset('js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ theme_asset('js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ theme_asset('js/main.js') }}"></script>
    
    @stack('scripts')
</body>
</html>
```

## Translation Files

Laravel's translation files are used for static text:

```php
// resources/lang/en/messages.php
return [
    'welcome' => 'Welcome to our website',
    'about_us' => 'About Us',
    'contact_us' => 'Contact Us',
    'read_more' => 'Read More',
    'submit' => 'Submit',
    'name' => 'Name',
    'email' => 'Email',
    'message' => 'Message',
    'phone' => 'Phone',
    'address' => 'Address',
    'follow_us' => 'Follow Us',
    'latest_news' => 'Latest News',
    'popular_posts' => 'Popular Posts',
    'categories' => 'Categories',
    'tags' => 'Tags',
    'search' => 'Search',
    'search_results' => 'Search Results',
    'no_results' => 'No results found',
    'home' => 'Home',
    'page_not_found' => 'Page Not Found',
    'error_404' => 'Error 404',
    'go_back' => 'Go Back',
    'copyright' => 'Copyright © :year. All rights reserved.',
];
```

```php
// resources/lang/sw/messages.php
return [
    'welcome' => 'Karibu kwenye tovuti yetu',
    'about_us' => 'Kuhusu Sisi',
    'contact_us' => 'Wasiliana Nasi',
    'read_more' => 'Soma Zaidi',
    'submit' => 'Wasilisha',
    'name' => 'Jina',
    'email' => 'Barua pepe',
    'message' => 'Ujumbe',
    'phone' => 'Simu',
    'address' => 'Anwani',
    'follow_us' => 'Tufuate',
    'latest_news' => 'Habari za Hivi Karibuni',
    'popular_posts' => 'Machapisho Maarufu',
    'categories' => 'Jamii',
    'tags' => 'Lebo',
    'search' => 'Tafuta',
    'search_results' => 'Matokeo ya Utafutaji',
    'no_results' => 'Hakuna matokeo yaliyopatikana',
    'home' => 'Nyumbani',
    'page_not_found' => 'Ukurasa Haukupatikana',
    'error_404' => 'Hitilafu 404',
    'go_back' => 'Rudi Nyuma',
    'copyright' => 'Hakimiliki © :year. Haki zote zimehifadhiwa.',
];
```

## Translation Helper

A helper directive for translations:

```php
namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\Blade;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     *
     * @return void
     */
    public function register()
    {
        //
    }

    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot()
    {
        // Register translation directive
        Blade::directive('t', function ($expression) {
            return "<?php echo trans($expression); ?>";
        });
    }
}
```

To use the translation directive in templates:

```php
<h1>@t('messages.welcome')</h1>
<p>@t('messages.about_us')</p>
```

## Conclusion

The internationalization and localization system provides a comprehensive approach to managing multilingual content in the CMS. By using Laravel's built-in localization features and extending them with custom traits and helpers, the system supports translating pages, widgets, and other content. The implementation is designed to work seamlessly with the Miata template while providing a robust backend architecture for multilingual websites.

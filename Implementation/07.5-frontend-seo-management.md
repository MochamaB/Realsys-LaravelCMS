# Frontend - SEO Management

This document outlines the SEO management system for the CMS, explaining how metadata and structured data are handled for search engine optimization.

## SEO Management Overview

The SEO management system consists of several components:

1. **Page Metadata**: Title, description, and keywords for each page
2. **Structured Data**: JSON-LD structured data for rich search results
3. **Social Media Tags**: Open Graph and Twitter Card tags
4. **Canonical URLs**: Proper canonical URL handling
5. **Sitemap Generation**: XML sitemap for search engines

## Page Metadata

Page metadata is stored in the `pages` table and rendered in the page templates:

```php
<!-- resources/themes/miata/layouts/default.blade.php -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page Title -->
    <title>{{ $page->meta_title ?? $page->title }} - {{ config('app.name') }}</title>
    
    <!-- Meta Description -->
    <meta name="description" content="{{ $page->meta_description }}">
    
    <!-- Meta Keywords -->
    @if($page->meta_keywords)
        <meta name="keywords" content="{{ $page->meta_keywords }}">
    @endif
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ url()->current() }}">
    
    <!-- ... other head content ... -->
</head>
<body>
    <!-- ... body content ... -->
</body>
</html>
```

## Structured Data

Structured data is added to pages using JSON-LD format:

```php
namespace App\Services;

use App\Models\Page;

class StructuredDataService
{
    /**
     * Generate structured data for a page
     *
     * @param Page $page
     * @return array
     */
    public function generateStructuredData(Page $page)
    {
        // Basic WebPage structured data
        $structuredData = [
            '@context' => 'https://schema.org',
            '@type' => 'WebPage',
            'name' => $page->title,
            'description' => $page->meta_description ?? $page->description,
            'url' => route('page.show', $page->slug),
            'inLanguage' => app()->getLocale(),
            'datePublished' => $page->created_at->toIso8601String(),
            'dateModified' => $page->updated_at->toIso8601String(),
            'publisher' => [
                '@type' => 'Organization',
                'name' => config('app.name'),
                'logo' => [
                    '@type' => 'ImageObject',
                    'url' => asset(settings('site_logo', 'themes/miata/images/logo.png'))
                ]
            ]
        ];
        
        // Add additional structured data based on page type
        switch ($page->template->slug) {
            case 'about':
                $structuredData['@type'] = 'AboutPage';
                break;
                
            case 'contact':
                $structuredData['@type'] = 'ContactPage';
                break;
                
            case 'article':
                $structuredData = $this->generateArticleStructuredData($page);
                break;
                
            case 'event':
                $structuredData = $this->generateEventStructuredData($page);
                break;
        }
        
        return $structuredData;
    }
    
    /**
     * Generate article structured data
     *
     * @param Page $page
     * @return array
     */
    protected function generateArticleStructuredData(Page $page)
    {
        return [
            '@context' => 'https://schema.org',
            '@type' => 'Article',
            'headline' => $page->title,
            'description' => $page->meta_description ?? $page->description,
            'image' => $this->getPageImage($page),
            'datePublished' => $page->created_at->toIso8601String(),
            'dateModified' => $page->updated_at->toIso8601String(),
            'author' => [
                '@type' => 'Person',
                'name' => $page->createdBy->name ?? config('app.name')
            ],
            'publisher' => [
                '@type' => 'Organization',
                'name' => config('app.name'),
                'logo' => [
                    '@type' => 'ImageObject',
                    'url' => asset(settings('site_logo', 'themes/miata/images/logo.png'))
                ]
            ],
            'mainEntityOfPage' => [
                '@type' => 'WebPage',
                '@id' => route('page.show', $page->slug)
            ]
        ];
    }
    
    /**
     * Generate event structured data
     *
     * @param Page $page
     * @return array
     */
    protected function generateEventStructuredData(Page $page)
    {
        // Get event data from page metadata or content
        $eventData = json_decode($page->metadata, true) ?? [];
        
        return [
            '@context' => 'https://schema.org',
            '@type' => 'Event',
            'name' => $page->title,
            'description' => $page->meta_description ?? $page->description,
            'image' => $this->getPageImage($page),
            'startDate' => $eventData['start_date'] ?? $page->created_at->toIso8601String(),
            'endDate' => $eventData['end_date'] ?? null,
            'location' => [
                '@type' => 'Place',
                'name' => $eventData['location_name'] ?? '',
                'address' => [
                    '@type' => 'PostalAddress',
                    'streetAddress' => $eventData['street_address'] ?? '',
                    'addressLocality' => $eventData['city'] ?? '',
                    'postalCode' => $eventData['postal_code'] ?? '',
                    'addressCountry' => $eventData['country'] ?? ''
                ]
            ],
            'organizer' => [
                '@type' => 'Organization',
                'name' => config('app.name'),
                'url' => url('/')
            ]
        ];
    }
    
    /**
     * Get the main image for a page
     *
     * @param Page $page
     * @return string|null
     */
    protected function getPageImage(Page $page)
    {
        // Try to find an image in the page content
        preg_match('/<img.+src=[\'"](?P<src>.+?)[\'"].*>/i', $page->content, $matches);
        
        if (isset($matches['src'])) {
            return $matches['src'];
        }
        
        // Try to find an image in the page's widgets
        $heroWidgets = $page->getWidgetsBySection('hero');
        
        foreach ($heroWidgets as $widget) {
            $data = $widget->getData();
            
            if (isset($data['image'])) {
                return asset('storage/' . $data['image']);
            }
            
            if (isset($data['slides']) && is_array($data['slides']) && count($data['slides']) > 0) {
                foreach ($data['slides'] as $slide) {
                    if (isset($slide['image'])) {
                        return asset('storage/' . $slide['image']);
                    }
                }
            }
        }
        
        // Return default image
        return asset(settings('default_og_image', 'themes/miata/images/og-image.jpg'));
    }
}
```

To include the structured data in the page template:

```php
<!-- resources/themes/miata/layouts/default.blade.php -->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... other head content ... -->
    
    <!-- Structured Data -->
    @php
        $structuredData = app(\App\Services\StructuredDataService::class)->generateStructuredData($page);
    @endphp
    <script type="application/ld+json">
        {!! json_encode($structuredData) !!}
    </script>
</head>
<body>
    <!-- ... body content ... -->
</body>
</html>
```

## Social Media Tags

Social media tags are added to improve sharing on platforms like Facebook and Twitter:

```php
<!-- resources/themes/miata/layouts/default.blade.php -->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... other head content ... -->
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="{{ $page->meta_title ?? $page->title }}">
    <meta property="og:description" content="{{ $page->meta_description }}">
    <meta property="og:url" content="{{ url()->current() }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="{{ config('app.name') }}">
    
    @php
        $ogImage = app(\App\Services\StructuredDataService::class)->getPageImage($page);
    @endphp
    <meta property="og:image" content="{{ $ogImage }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ $page->meta_title ?? $page->title }}">
    <meta name="twitter:description" content="{{ $page->meta_description }}">
    <meta name="twitter:image" content="{{ $ogImage }}">
    
    @if(settings('twitter_site'))
        <meta name="twitter:site" content="{{ settings('twitter_site') }}">
    @endif
</head>
<body>
    <!-- ... body content ... -->
</body>
</html>
```

## Canonical URLs

Canonical URLs help prevent duplicate content issues:

```php
namespace App\Services;

use Illuminate\Http\Request;

class CanonicalUrlService
{
    /**
     * Generate canonical URL for the current request
     *
     * @param Request $request
     * @return string
     */
    public function getCanonicalUrl(Request $request)
    {
        $url = $request->url();
        
        // Remove trailing slash
        $url = rtrim($url, '/');
        
        // Remove query parameters
        $url = strtok($url, '?');
        
        // Force HTTPS if configured
        if (config('app.force_https')) {
            $url = str_replace('http://', 'https://', $url);
        }
        
        return $url;
    }
}
```

To use the canonical URL service in the template:

```php
<!-- resources/themes/miata/layouts/default.blade.php -->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... other head content ... -->
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ app(\App\Services\CanonicalUrlService::class)->getCanonicalUrl(request()) }}">
</head>
<body>
    <!-- ... body content ... -->
</body>
</html>
```

## Sitemap Generation

A sitemap is generated to help search engines discover and index pages:

```php
namespace App\Services;

use App\Models\Page;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\URL;

class SitemapService
{
    /**
     * Generate XML sitemap
     *
     * @return string
     */
    public function generateSitemap()
    {
        // Cache sitemap for 24 hours
        return Cache::remember('sitemap', 60 * 24, function () {
            $pages = Page::where('is_active', true)->get();
            
            $xml = '<?xml version="1.0" encoding="UTF-8"?>';
            $xml .= '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">';
            
            // Add home page
            $xml .= '<url>';
            $xml .= '<loc>' . url('/') . '</loc>';
            $xml .= '<lastmod>' . now()->toIso8601String() . '</lastmod>';
            $xml .= '<changefreq>daily</changefreq>';
            $xml .= '<priority>1.0</priority>';
            $xml .= '</url>';
            
            // Add other pages
            foreach ($pages as $page) {
                $xml .= '<url>';
                $xml .= '<loc>' . route('page.show', $page->slug) . '</loc>';
                $xml .= '<lastmod>' . $page->updated_at->toIso8601String() . '</lastmod>';
                $xml .= '<changefreq>weekly</changefreq>';
                $xml .= '<priority>0.8</priority>';
                $xml .= '</url>';
            }
            
            $xml .= '</urlset>';
            
            return $xml;
        });
    }
}
```

To create a route for the sitemap:

```php
// routes/web.php

// Sitemap
Route::get('/sitemap.xml', function () {
    $sitemap = app(\App\Services\SitemapService::class)->generateSitemap();
    
    return response($sitemap, 200)
        ->header('Content-Type', 'application/xml');
});
```

## SEO Middleware

An SEO middleware can be used to add additional headers and perform SEO-related tasks:

```php
namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class SeoMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle(Request $request, Closure $next)
    {
        $response = $next($request);
        
        // Add X-Robots-Tag header if needed
        if (config('app.environment') !== 'production') {
            $response->header('X-Robots-Tag', 'noindex, nofollow');
        }
        
        // Add Content-Security-Policy header
        $response->header('Content-Security-Policy', "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.googleapis.com *.gstatic.com; style-src 'self' 'unsafe-inline' *.googleapis.com; img-src 'self' data: *.googleapis.com; font-src 'self' data: *.gstatic.com *.googleapis.com; connect-src 'self';");
        
        return $response;
    }
}
```

Register the middleware in the `Kernel.php` file:

```php
protected $middlewareGroups = [
    'web' => [
        // ... other middleware
        \App\Http\Middleware\SeoMiddleware::class,
    ],
];
```

## Meta Tags Component

A reusable component for meta tags can simplify the implementation:

```php
namespace App\View\Components;

use App\Models\Page;
use App\Services\StructuredDataService;
use App\Services\CanonicalUrlService;
use Illuminate\View\Component;

class MetaTags extends Component
{
    public $page;
    public $structuredData;
    public $canonicalUrl;
    public $ogImage;
    
    /**
     * Create a new component instance.
     *
     * @param Page $page
     * @return void
     */
    public function __construct(Page $page)
    {
        $this->page = $page;
        $this->structuredData = app(StructuredDataService::class)->generateStructuredData($page);
        $this->canonicalUrl = app(CanonicalUrlService::class)->getCanonicalUrl(request());
        $this->ogImage = app(StructuredDataService::class)->getPageImage($page);
    }
    
    /**
     * Get the view / contents that represent the component.
     *
     * @return \Illuminate\View\View
     */
    public function render()
    {
        return view('theme::components.meta-tags');
    }
}
```

```php
<!-- resources/themes/miata/components/meta-tags.blade.php -->
<!-- Page Title -->
<title>{{ $page->meta_title ?? $page->title }} - {{ config('app.name') }}</title>

<!-- Meta Description -->
<meta name="description" content="{{ $page->meta_description }}">

<!-- Meta Keywords -->
@if($page->meta_keywords)
    <meta name="keywords" content="{{ $page->meta_keywords }}">
@endif

<!-- Canonical URL -->
<link rel="canonical" href="{{ $canonicalUrl }}">

<!-- Open Graph Tags -->
<meta property="og:title" content="{{ $page->meta_title ?? $page->title }}">
<meta property="og:description" content="{{ $page->meta_description }}">
<meta property="og:url" content="{{ $canonicalUrl }}">
<meta property="og:type" content="website">
<meta property="og:site_name" content="{{ config('app.name') }}">
<meta property="og:image" content="{{ $ogImage }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $page->meta_title ?? $page->title }}">
<meta name="twitter:description" content="{{ $page->meta_description }}">
<meta name="twitter:image" content="{{ $ogImage }}">

@if(settings('twitter_site'))
    <meta name="twitter:site" content="{{ settings('twitter_site') }}">
@endif

<!-- Structured Data -->
<script type="application/ld+json">
    {!! json_encode($structuredData) !!}
</script>
```

To use the component in the layout:

```php
<!-- resources/themes/miata/layouts/default.blade.php -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <x-meta-tags :page="$page" />
    
    <!-- ... other head content ... -->
</head>
<body>
    <!-- ... body content ... -->
</body>
</html>
```

## Conclusion

The SEO management system provides a comprehensive approach to search engine optimization for the CMS. By implementing proper metadata, structured data, social media tags, canonical URLs, and sitemap generation, the system helps improve search engine visibility and social media sharing. The implementation is designed to work seamlessly with the Miata template while providing a robust backend architecture for SEO management.
